<!DOCTYPE html>
<html>

<head>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
</head>

<body>
    <div id="container" style="width:100%; height:400px;"></div>
    <script>
        Promise.all([
            fetch('clean_dataset.csv')
                .then(response => response.text())
                .catch(error => console.error('Error fetching clean_dataset.csv:', error)),
            fetch('cities.csv')
                .then(response => response.text())
                .catch(error => console.error('Error fetching cities.csv:', error))
        ])
            .then(([dataCsv1, dataCsv2]) => {
                try {
                    var data1 = Papa.parse(dataCsv1, { header: true }).data;
                    var data2 = Papa.parse(dataCsv2, { header: true }).data;

                    console.log('Data 1:', data1);
                    console.log('Data 2:', data2);

                    var mergedData = _.mergeWith(
                        _.keyBy(data1, 'city'),
                        _.keyBy(data2, 'city'),
                        (objValue, srcValue) => {
                            if (_.isObject(objValue) && _.isObject(srcValue)) {
                                return _.merge(objValue, srcValue);
                            }
                        }
                    );
                    console.log('Merged Data:', mergedData);

                    var processedData = _.map(mergedData, row => ({
                        name: row.city_heb + ' (' + row.city + ')',
                        y: parseFloat(row.incidents) / parseFloat(row.population)
                    }));

                    console.log('Processed Data:', processedData);

                    Highcharts.chart('container', {
                        chart: {
                            type: 'bar'
                        },
                        title: {
                            text: 'Littering Incidents per Capita by City'
                        },
                        xAxis: {
                            type: 'category'
                        },
                        yAxis: {
                            title: {
                                text: 'Incidents per Capita'
                            }
                        },
                        series: [{
                            name: 'Cities',
                            data: processedData
                        }]
                    });
                } catch (e) {
                    console.error('Error while processing data or creating chart:', e);
                }
            })
            .catch(error => console.error('Error in Promise.all:', error));
    </script>
</body>

</html>