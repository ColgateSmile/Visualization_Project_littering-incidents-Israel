<!DOCTYPE html>
<html>

<head>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
</head>

<body>
    <div id="container" style="width:100%; height:400px;"></div>
    <script>
        Promise.all([
            fetch('clean_dataset.csv')
                .then(response => response.text())
                .catch(error => console.error('Error fetching clean_dataset.csv:', error)),
            fetch('cities.csv')
                .then(response => response.text())
                .catch(error => console.error('Error fetching cities.csv:', error))
        ])
            .then(([dataCsv1, dataCsv2]) => {
                try {
                    var data1 = Papa.parse(dataCsv1, { header: true }).data;
                    var data2 = Papa.parse(dataCsv2, { header: true }).data;

                    // Group data1 by city and calculate total incidents
                    var incidentsByCity = _.groupBy(data1, 'city');
                    var totalIncidentsByCity = _.mapValues(incidentsByCity, cityData => cityData.length);

                    // Group data2 by city and calculate total population
                    var populationByCity = _.keyBy(data2, 'city');
                    var totalPopulationByCity = _.mapValues(populationByCity, cityData => parseInt(cityData.population));

                    // Merge total incidents and total population by city
                    var mergedData = _.mergeWith(
                        totalIncidentsByCity,
                        totalPopulationByCity,
                        (totalIncidents, totalPopulation) => ({ totalIncidents, totalPopulation })
                    );

                    // Calculate incidents per capita for each city
                    var processedData = _.map(mergedData, (data, city) => ({
                        name: data.city_heb + ' (' + city + ')',
                        y: data.totalIncidents / data.totalPopulation
                    }));

                    console.log('Processed Data:', processedData);

                    Highcharts.chart('container', {
                        chart: {
                            type: 'bar'
                        },
                        title: {
                            text: 'Littering Incidents per Capita by City'
                        },
                        xAxis: {
                            type: 'category'
                        },
                        yAxis: {
                            title: {
                                text: 'Incidents per Capita'
                            }
                        },
                        series: [{
                            name: 'Cities',
                            data: processedData
                        }]
                    });
                } catch (e) {
                    console.error('Error while processing data or creating chart:', e);
                }
            })
            .catch(error => console.error('Error in Promise.all:', error));
    </script>
</body>

</html>